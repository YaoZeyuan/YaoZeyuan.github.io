

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/static/img/favicon.ico">
  <link rel="icon" href="/static/img/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="姚泽源">
  <meta name="keywords" content="">
  
    <meta name="description" content="当抵达 Node 服务的请求数达到理论最高吞吐量时, 单个请求的响应时间和所有请求平均响应时间会是什么关系? 答: 所有请求平均响应时间一切如常, 单个请求响应时间突然飞涨 为什么是这样?  周末接到三次报警, 线上 Node 服务突然出现大量接口 30 秒超时. 但每次都是刚连上 vpn, 报警就消失. 期间没有上线操作, 流量不大且平稳, 报错的是普通接口逻辑流程正常, 99.5%的请求响应">
<meta property="og:type" content="article">
<meta property="og:title" content="异步模型的脆折风险----从一次 Node 服务故障谈起">
<meta property="og:url" content="https://www.yaozeyuan.online/2021/06/28/2021/06/%E5%BC%82%E6%AD%A5%E6%A8%A1%E5%9E%8B%E7%9A%84%E8%84%86%E6%8A%98%E9%A3%8E%E9%99%A9----%E4%BB%8E%E4%B8%80%E6%AC%A1%20Node%20%E6%9C%8D%E5%8A%A1%E6%95%85%E9%9A%9C%E8%B0%88%E8%B5%B7/index.html">
<meta property="og:site_name" content="代号647">
<meta property="og:description" content="当抵达 Node 服务的请求数达到理论最高吞吐量时, 单个请求的响应时间和所有请求平均响应时间会是什么关系? 答: 所有请求平均响应时间一切如常, 单个请求响应时间突然飞涨 为什么是这样?  周末接到三次报警, 线上 Node 服务突然出现大量接口 30 秒超时. 但每次都是刚连上 vpn, 报警就消失. 期间没有上线操作, 流量不大且平稳, 报错的是普通接口逻辑流程正常, 99.5%的请求响应">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E6%8A%96%E5%8A%A8%E6%9C%9F%E9%97%B4QPS+%E6%8E%A5%E5%8F%A3%E5%93%8D%E5%BA%94%E6%97%B6%E9%95%BF%E5%90%88%E5%B9%B6%E6%95%B0%E6%8D%AE.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E7%90%86%E6%83%B3%E5%90%8C%E6%AD%A5io%E5%A4%84%E7%90%86%E6%A8%A1%E5%9E%8B.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E7%90%86%E6%83%B3%E5%BC%82%E6%AD%A5io%E5%A4%84%E7%90%86%E6%A8%A1%E5%9E%8B.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E8%AF%B7%E6%B1%82%E6%A8%A1%E5%9E%8B.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/Node%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E5%AE%9E%E9%99%85%E5%BC%82%E6%AD%A5io%E5%A4%84%E7%90%86%E6%A8%A1%E5%9E%8B.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E8%AE%A1%E7%AE%97%E5%AF%86%E9%9B%86%E5%9E%8B%E5%BC%82%E6%AD%A5io%E5%A4%84%E7%90%86%E6%A8%A1%E5%9E%8B.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E5%B9%B6%E5%8F%91%E9%87%8F%E8%BF%87%E5%A4%A7%E6%97%B6%E7%9A%84%E5%BC%82%E6%AD%A5io%E5%A4%84%E7%90%86%E6%A8%A1%E5%9E%8B.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C/%E8%AE%A1%E7%AE%97%E5%AF%86%E9%9B%86%E5%9E%8B-%E5%B9%B6%E5%8F%911.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C/%E8%AE%A1%E7%AE%97%E5%AF%86%E9%9B%86%E5%9E%8B-%E5%B9%B6%E5%8F%9110.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C/%E8%AE%A1%E7%AE%97%E5%AF%86%E9%9B%86%E5%9E%8B-%E5%B9%B6%E5%8F%91100.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C/%E8%AE%A1%E7%AE%97%E5%AF%86%E9%9B%86%E5%9E%8B-%E5%B9%B6%E5%8F%91400.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C/io%E5%AF%86%E9%9B%86%E5%9E%8B-%E5%B9%B6%E5%8F%911.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C/io%E5%AF%86%E9%9B%86%E5%9E%8B-%E5%B9%B6%E5%8F%9110.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C/io%E5%AF%86%E9%9B%86%E5%9E%8B-%E5%B9%B6%E5%8F%91100.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C/io%E5%AF%86%E9%9B%86%E5%9E%8B-%E5%B9%B6%E5%8F%91400.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C/io%E5%AF%86%E9%9B%86%E5%9E%8B-%E5%B9%B6%E5%8F%911000.png">
<meta property="article:published_time" content="2021-06-28T00:00:00.000Z">
<meta property="article:modified_time" content="2022-06-27T04:09:06.936Z">
<meta property="article:author" content="姚泽源">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E6%8A%96%E5%8A%A8%E6%9C%9F%E9%97%B4QPS+%E6%8E%A5%E5%8F%A3%E5%93%8D%E5%BA%94%E6%97%B6%E9%95%BF%E5%90%88%E5%B9%B6%E6%95%B0%E6%8D%AE.jpg">
  
  
  
  <title>异步模型的脆折风险----从一次 Node 服务故障谈起 - 代号647</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/static/css/customer.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"www.yaozeyuan.online","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":false,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"edcdb2b6206614cd62e6206e4c410bf5","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?edcdb2b6206614cd62e6206e4c410bf5";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  

  

  

  

  

  



  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>代号647</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/static/img/banner/background.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="异步模型的脆折风险----从一次 Node 服务故障谈起"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2021-06-28 08:00" pubdate>
          2021年6月28日 早上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          9.6k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          80 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">异步模型的脆折风险----从一次 Node 服务故障谈起</h1>
            
            
              <div class="markdown-body">
                
                <blockquote>
<p>当抵达 Node 服务的请求数达到理论最高吞吐量时, 单个请求的响应时间和所有请求平均响应时间会是什么关系?</p>
<p>答: 所有请求平均响应时间一切如常, 单个请求响应时间突然飞涨</p>
<p>为什么是这样?</p>
</blockquote>
<p>周末接到三次报警, 线上 Node 服务突然出现大量接口 30 秒超时. 但每次都是刚连上 vpn, 报警就消失. 期间没有上线操作, 流量不大且平稳, 报错的是普通接口逻辑流程正常, 99.5%的请求响应时间在 100ms 以内, 服务器 CPU 使用率稳定在 30% 且无波动, 内存使用无波动, 硬盘读写无波动. 但就是突然几千个请求响超时, 故障期间连服务器上的静态资源文件也拉不下来, 然后自动恢复正常…why?</p>
<h2 id="排查步骤">排查步骤</h2>
<h3 id="问题表现">问题表现</h3>
<p>需要先确认问题表现, 在这次报警中, 问题表现如下</p>
<ol>
<li>
<p>服务短时间内出现大量请求超时, 30 秒内无响应, 504 报错</p>
</li>
<li>
<p>在服务故障期间(排查期间正好赶上一次故障), 访问服务器上的静态资源文件(只需要服务进程进行简单读取磁盘)也没有响应, 说明服务进程处于&quot;卡死&quot;状态</p>
</li>
<li>
<p>代码发版</p>
<ol>
<li>最近 7 天无发版操作</li>
</ol>
</li>
<li>
<p>通过查询日志, 报错前 3 天内没有发生过重启, 报错期间也没有进程重启事件</p>
</li>
<li>
<p>历史报警</p>
<ol>
<li>5 天前晚 7 点左右也有一次 504 报警, 1 分钟后解除, 当时排查后认为是网络抖动, 没有注意</li>
</ol>
</li>
<li>
<p>服务器</p>
<ol>
<li>服务器 CPU 使用率无波动, 稳定在 30% 左右</li>
<li>服务进程 CPU 使用率大致在 16~25% 之间</li>
<li>磁盘 io 无波动</li>
<li>内存使用无波动, 且有较大冗余空间</li>
</ol>
</li>
<li>
<p>请求流量</p>
<ol>
<li>日常 QPS 6~10</li>
<li>故障期间(11:05:00~11:20:00)
<ol>
<li>最高 QPS 67, 持续 1 秒, 随后恢复正常</li>
<li>平均每分钟有一次 QPS 为 20 的并发, 但只维持 1 秒</li>
</ol>
</li>
</ol>
</li>
<li>
<p>接口响应时间</p>
<ol>
<li>日常接口响应时间 40~50ms</li>
<li>故障期间(11:05:00~11:20:00)
<ol>
<li>每分钟有一批接口响应时间在 1~3 秒, 只持续 1 秒</li>
<li>故障期间接口响应时间快速升高, 然后达到 30s, 持续 60s 后快速下降回正常状态</li>
</ol>
</li>
</ol>
</li>
<li>
<p>线上服务器日志</p>
<ol>
<li>服务器本身只有 200 的日志记录, 通过 grep 遍历搜索, 没有 504 超时记录.</li>
<li>504 超时记录只出现在 Nginx 日志中</li>
<li>看到的记录响应耗时大部分为 0, 偶有 40~100 的情况</li>
</ol>
</li>
<li>
<p>服务器情况</p>
<ol>
<li><strong>线上三台服务器几乎同步发生异常, 然后同步恢复</strong></li>
</ol>
</li>
<li>
<p>日常接口响应时间</p>
<ol>
<li>每天大约有 1000 个请求响应时间在 300ms 以上, 但都是集中出现一阵后消失, 没有规律</li>
</ol>
</li>
<li>
<p>原始请求日志</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><br>请求时间  响应时长  请求接口<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">25</span> <span class="hljs-number">0.091</span>   /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">25</span> <span class="hljs-number">0.036</span>   /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">25</span> <span class="hljs-number">0.040</span>   /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">25</span> <span class="hljs-number">0.036</span>   /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">25</span> <span class="hljs-number">0.045</span>   /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">25</span> <span class="hljs-number">0.054</span>   /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">25</span> <span class="hljs-number">0.151</span>   /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">25</span> <span class="hljs-number">0.036</span>   /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">25</span> <span class="hljs-number">0.106</span>   /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">26</span> <span class="hljs-number">0.046</span>   /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">26</span> <span class="hljs-number">0.061</span>   /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">26</span> <span class="hljs-number">0.056</span>   /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">26</span> <span class="hljs-number">0.042</span>   /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">28</span> <span class="hljs-number">2.177</span>   /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">28</span> <span class="hljs-number">0.811</span>   /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">28</span> <span class="hljs-number">2.377</span>   /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">28</span> <span class="hljs-number">0.929</span>   /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">29</span> <span class="hljs-number">2.916</span>   /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">30</span> <span class="hljs-number">2.735</span>   /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">40</span> <span class="hljs-number">14.397</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">46</span> <span class="hljs-number">19.809</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">46</span> <span class="hljs-number">1.723</span>   /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">48</span> <span class="hljs-number">21.274</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">48</span> <span class="hljs-number">1.063</span>   /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">49</span> <span class="hljs-number">3.777</span>   /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">49</span> <span class="hljs-number">22.506</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">49</span> <span class="hljs-number">21.235</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">49</span> <span class="hljs-number">22.760</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">49</span> <span class="hljs-number">22.239</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">49</span> <span class="hljs-number">22.534</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">50</span> <span class="hljs-number">21.391</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">50</span> <span class="hljs-number">14.277</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">50</span> <span class="hljs-number">21.354</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">50</span> <span class="hljs-number">15.353</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">50</span> <span class="hljs-number">22.900</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">50</span> <span class="hljs-number">20.077</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">50</span> <span class="hljs-number">20.772</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">50</span> <span class="hljs-number">10.949</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">50</span> <span class="hljs-number">16.745</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">50</span> <span class="hljs-number">22.802</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">50</span> <span class="hljs-number">22.125</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">56</span> <span class="hljs-number">30.000</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">57</span> <span class="hljs-number">30.001</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">57</span> <span class="hljs-number">30.001</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">58</span> <span class="hljs-number">30.000</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">59</span> <span class="hljs-number">30.000</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">59</span> <span class="hljs-number">30.000</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">59</span> <span class="hljs-number">30.001</span>  /api/xxx/list<br>09:<span class="hljs-number">20</span>:<span class="hljs-number">59</span> <span class="hljs-number">30.000</span>  /api/xxx/list<br></code></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="代码问题">代码问题</h3>
<p>对于线上服务故障, 第一反应就是检查代码本身是否有问题. 由于是新业务, 排查日志发现 90%的请求都在访问<code>/api/xxx/list</code>, 所以检查起来比较简单. 经审核, 代码没有问题, 也没有明显存在风险的点. 考虑到如果代码真有问题, 那之前一定会有报错记录. 于是翻查请求历史日志, 发现请求都能在 50ms 内正常响应, 说明代码本身确实没毛病.</p>
<h3 id="MySQL-慢查询-远程服务无响应">MySQL 慢查询 / 远程服务无响应</h3>
<p>排除代码本身问题后, 紧接着需要考虑的是 MySQL 集群故障/ 慢查询的可能. 如果 MySQL 调用超时, 那 await 等待远程接口响应的 Node 服务自然也会超时.但这个想法很快被排除掉了, 主要是两个原因:</p>
<ol>
<li>假设是 MySQL 集群故障, 查询无响应. 那么同一时间段内, 依赖 MySQL 集群的其他服务必然也会报错, 不会只有我们一个服务故障. 但现实是故障期间只有我们的服务出现了 504 超时错误.</li>
<li>如果请求卡在等待远程调用中, 由于 Node 使用的是异步模型, 服务进程并不会阻塞在等待接口响应上. 此时其他接口/静态文件(不依赖外部接口)应该可以继续访问. 但在问题描述中可以看到, 故障期间静态文件也无法访问. 所以问题更像是整个服务进程失去了响应, 而非 MySQL 集群有问题.</li>
</ol>
<p>MySQL 问题排除.</p>
<h3 id="服务器问题">服务器问题</h3>
<p>有没有可能是服务器本身挂了呢? 但这也没可能:</p>
<ol>
<li>故障期间服务器上其他应用响应正常</li>
<li>位于三台服务器上的进程几乎同步故障, 说明是三台机器间共有的部分出错, 不像是单台服务器故障</li>
</ol>
<h3 id="服务进程本身问题">服务进程本身问题</h3>
<p>代码没有问题, MySQL 没有问题, 服务器也没有问题. 那只能是服务进程本身出了毛病.</p>
<p>通过故障期间每秒接口响应数(QPS)+接口响应时长合并图可以看到, 接口响应时长和 QPS 明显相关, 当 QPS 变大时, 接口响应时长一般都会随之增加, 而增大到极值(11:17~11:19), 响应时长突破 30s, 对应的就是线上 Nginx 504 报错. 但是, 服务器压力大导致接口超时可以理解, 但为什么静态资源请求也跟着超时? 为什么会这样?</p>
<p><img src="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E6%8A%96%E5%8A%A8%E6%9C%9F%E9%97%B4QPS+%E6%8E%A5%E5%8F%A3%E5%93%8D%E5%BA%94%E6%97%B6%E9%95%BF%E5%90%88%E5%B9%B6%E6%95%B0%E6%8D%AE.jpg" alt="抖动期间QPS+接口响应时长合并数据"></p>
<h1>异步模型的脆折风险</h1>
<p>所有这些, 需要从 io 请求处理模型说起.</p>
<p><img src="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E7%90%86%E6%83%B3%E5%90%8C%E6%AD%A5io%E5%A4%84%E7%90%86%E6%A8%A1%E5%9E%8B.jpg" alt="理想同步io模型"></p>
<p>传统 io 模型是串行模式, 一个一个处理请求. 可以看到, 处理 6 个请求时, 总耗时 1200ms. 大量时间浪费在 io 等待中.</p>
<p><img src="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E7%90%86%E6%83%B3%E5%BC%82%E6%AD%A5io%E5%A4%84%E7%90%86%E6%A8%A1%E5%9E%8B.jpg" alt="理想异步io处理模型"></p>
<p>为了避免浪费, 提升服务器吞吐率, 异步 io 模型应运而生. 异步的基本思路是时间复用, 在等待 io 的期间让 CPU 去处理其他请求, 从而充分利用计算资源. 可以看到, 在理想情况下, 异步模型处理 6 个请求只需要 650ms.</p>
<p>不过, 这是理想情况. 在实际应用中, 请求的计算部分和 io 等待部分会交织在一起, 由于每个部分消耗时间都不太长, 因此会形成<strong>时间片</strong>的效果. 只有执行完所有时间片, 一个任务才能执行完成.</p>
<p><img src="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E8%AF%B7%E6%B1%82%E6%A8%A1%E5%9E%8B.jpg" alt="请求模型.jpg"></p>
<p>而当多个请求同时到达 Node 进程时, Node 的任务队列会变成下边这样: 不同请求的回调在任务队列中进行等待执行.</p>
<p><img src="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/Node%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97.jpg" alt="Node任务队列.jpg"></p>
<p>由于接口响应过程被异步等待被拆分成一个个子任务, 形成了<strong>细碎的时间片</strong>, 接口的异步处理模型如下图所示. 当多个请求同时到达时, 由于 io 等待+任务队列调度的效果, Node 倾向于在请求间平均分配时间片, <strong>对同一接口同时到达的请求倾向于同时完成</strong>. 但可以看出, 即使切换时间片本身需要时间, 导致单个请求响应时长增加, 但因为可以利用 io 等待时间, 异步模型仍然比串行模式要高效.</p>
<p><img src="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E5%AE%9E%E9%99%85%E5%BC%82%E6%AD%A5io%E5%A4%84%E7%90%86%E6%A8%A1%E5%9E%8B.jpg" alt="实际异步io处理模型"></p>
<p>那如果待执行的任务没有 io 操作, 是<strong>纯计算密集型请求</strong>呢?</p>
<p>那就会悲剧. 如果是计算密集型请求, 异步模型的处理能力会回落到和串行模型同一水平, 甚至更差: <strong>在串行模式下, 高并发时串行模式至少可以保证前几个接口的正常响应</strong>, 后续接口由于等待时间过长才会超时报 504. 但在异步模型下, <strong>由于在各个任务间不断进行调度, 所有任务的完成时间都差不多, 会导致最终没有一个请求可以正常响应, 所有任务一起 504 超时报错</strong></p>
<p>如下图所示</p>
<p><img src="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E8%AE%A1%E7%AE%97%E5%AF%86%E9%9B%86%E5%9E%8B%E5%BC%82%E6%AD%A5io%E5%A4%84%E7%90%86%E6%A8%A1%E5%9E%8B.jpg" alt="计算密集型异步io处理模型"></p>
<p>一般认为, web 服务是典型的 io 密集型场景, 大量时间消耗在 MySQL 通信与和其他接口交互中, 所以 Node 的异步模型天然适合用做 web 服务器. 但在特殊场景下, web 服务也会由 io 密集型退化为计算密集型: <strong>当请求数量超过阈值, 请求提供的 io 等待时长不足以完成其他请求的 CPU 操作时</strong>, 此时 CPU 就会变成服务的性能瓶颈. 由于所有请求都没有足够的 CPU 资源完成运算, 导致所有请求都<code>无法在可接受时间内响应</code>, 出现服务进程<code>&quot;卡死&quot;</code>的效果.</p>
<p>由于这个过程的临界点是<code>待处理请求所需的总CPU处理时长</code>大于<code>待处理请求所需的总IO时长</code>, 所以当问题发生时, 会有类似于钢板脆折的效果. 在临界点以下, 一切安好, 响应时长正常, 看不出有什么问题. 一旦超过临界点, 响应时长快速增加, 然后就是大规模 504 报错, 直到请求量降到临界点以下, 处理完所有挤压请求后, 一切又回归正常.</p>
<p><img src="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E5%B9%B6%E5%8F%91%E9%87%8F%E8%BF%87%E5%A4%A7%E6%97%B6%E7%9A%84%E5%BC%82%E6%AD%A5io%E5%A4%84%E7%90%86%E6%A8%A1%E5%9E%8B.jpg" alt="并发量过大时的异步io处理模型"></p>
<p>所以 Node 服务会有一个很特殊的现象: 绝大多数情况下表现正常, 但当并发量比最大容纳值稍微高一点, <strong>所有接口</strong>响应速度就会快速抬升(脆折), 但请求量只要降一点, 服务性能又会恢复正常. 整个表现非常反直觉, 但符合异步模型的原理.</p>
<h1>实践验证</h1>
<p>说了这么多, 实际测试一下.</p>
<p>压测框架使用 koa, 分别用<code>asyncSetTimeoutSleep</code>和<code>asyncCPUSleep</code>模拟 io 密集型和计算密集型请求, 压测工具使用 ApacheBench, 测试命令为<code>ab -c 1/10/100/400 -n 10000 -k 'http://127.0.0.1:3000/'</code>, <code>-n</code>指测试总数, 取 10000, <code>-c</code>指每轮测试并发请求数, 分别取 1/10/100/400 进行测试, 测试代码&amp;实验结果如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 测试代码</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;koa&quot;</span>);<br><span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">asyncSetTimeoutSleep</span>(<span class="hljs-params">ms = <span class="hljs-number">0</span></span>) &#123;<br>  <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">reslove, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-title function_">reslove</span>(<span class="hljs-literal">true</span>);<br>    &#125;, ms);<br>  &#125;);<br>  <span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">asyncCPUSleep</span>(<span class="hljs-params">ms = <span class="hljs-number">0</span></span>) &#123;<br>  <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">reslove, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-comment">// 这里必须使用setTimeout模拟sleep, 否则Node会由于没有调度机会,只能按先后顺序处理请求</span><br>    <span class="hljs-comment">// (接受请求1-&gt;处理请求1-&gt;响应请求1-&gt;接受请求2-&gt;处理请求2-&gt;响应请求2-&gt;...)</span><br>    <span class="hljs-comment">// 此时异步模式降级为串行模式, 失去比较意义</span><br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-comment">// 运算150000次在我的机器上正好是1ms, 单纯用来模拟CPU密集型操作, 没有特别意义</span><br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1500000</span> * ms; i++) &#123;&#125;<br>      <span class="hljs-title function_">reslove</span>(<span class="hljs-literal">true</span>);<br>    &#125;, <span class="hljs-number">0</span>);<br>  &#125;);<br>  <span class="hljs-keyword">return</span>;<br>&#125;<br><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">async</span> (ctx) =&gt; &#123;<br>  <span class="hljs-comment">// await asyncCPUSleep(10);</span><br>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">asyncSetTimeoutSleep</span>(<span class="hljs-number">10</span>);<br>  ctx.<span class="hljs-property">body</span> = <span class="hljs-string">&quot;Hello Koa&quot;</span>;<br>&#125;);<br><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);<br></code></pre></td></tr></table></figure>
<p>计算密集型</p>
<!-- ![计算密集型_表格](https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/计算密集型_表格.png) -->
<table>
<thead>
<tr>
<th style="text-align:left">并发量/响应时长</th>
<th style="text-align:left">最小值[ms]</th>
<th style="text-align:left">平均数[ms]</th>
<th style="text-align:left">中位数[ms]</th>
<th style="text-align:left">最大值[ms]</th>
<th>平均请求响应时间(总时长/总请求数)[ms]</th>
<th>总响应时长[s]</th>
<th>QPS[次/秒]</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">7</td>
<td style="text-align:left">11</td>
<td style="text-align:left">10</td>
<td style="text-align:left">37</td>
<td>11.172</td>
<td>111.724</td>
<td>89.51</td>
</tr>
<tr>
<td style="text-align:left">10</td>
<td style="text-align:left">10</td>
<td style="text-align:left">108</td>
<td style="text-align:left">106</td>
<td style="text-align:left">264</td>
<td>10.792</td>
<td>107.920</td>
<td>92.66</td>
</tr>
<tr>
<td style="text-align:left">100</td>
<td style="text-align:left">34</td>
<td style="text-align:left">1081</td>
<td style="text-align:left">1097</td>
<td style="text-align:left">1403</td>
<td>10.847</td>
<td>108.472</td>
<td>92.19</td>
</tr>
<tr>
<td style="text-align:left">400</td>
<td style="text-align:left">100</td>
<td style="text-align:left">4216</td>
<td style="text-align:left">4437</td>
<td style="text-align:left">4675</td>
<td>10.753</td>
<td>107.534</td>
<td>92.99</td>
</tr>
</tbody>
</table>
<p>io 密集型</p>
<!-- ![io密集型_表格](https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/io密集型_表格.png) -->
<table>
<thead>
<tr>
<th style="text-align:left">并发量/响应时长</th>
<th style="text-align:left">最小值[ms]</th>
<th style="text-align:left">平均数[ms]</th>
<th style="text-align:left">中位数[ms]</th>
<th style="text-align:left">最大值[ms]</th>
<th>平均请求响应时间(总时长/总请求数)[ms]</th>
<th>总响应时长[s]</th>
<th>QPS[次/秒]</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">9</td>
<td style="text-align:left">11</td>
<td style="text-align:left">11</td>
<td style="text-align:left">12</td>
<td>10.614</td>
<td>106.139</td>
<td>94.22</td>
</tr>
<tr>
<td style="text-align:left">10</td>
<td style="text-align:left">9</td>
<td style="text-align:left">11</td>
<td style="text-align:left">11</td>
<td style="text-align:left">14</td>
<td>1.086</td>
<td>10.857</td>
<td>921.03</td>
</tr>
<tr>
<td style="text-align:left">100</td>
<td style="text-align:left">10</td>
<td style="text-align:left">14</td>
<td style="text-align:left">13</td>
<td style="text-align:left">43</td>
<td>0.144</td>
<td>1.442</td>
<td>6934.20</td>
</tr>
<tr>
<td style="text-align:left">400</td>
<td style="text-align:left">20</td>
<td style="text-align:left">43</td>
<td style="text-align:left">35</td>
<td style="text-align:left">150</td>
<td>0.110</td>
<td>1.099</td>
<td>9099.80</td>
</tr>
<tr>
<td style="text-align:left">1000</td>
<td style="text-align:left">35</td>
<td style="text-align:left">70</td>
<td style="text-align:left">67</td>
<td style="text-align:left">130</td>
<td>0.086</td>
<td>0.861</td>
<td>11618.10</td>
</tr>
</tbody>
</table>
<p>可以看到</p>
<ul>
<li>当并发量为 1 时, 实际为串行模式, 此时<code>请求平均响应时间</code>等于<code>平均请求响应时间</code>, 计算密集型请求和 io 密集型请求吞吐量&amp;平均请求响应时长接近.</li>
<li>当并发量增大时
<ul>
<li>对于 计算密集型请求
<ul>
<li>异步模型没有可供利用的 io 等待时间, <code>平均请求响应时间</code>等于<code>单个请求必要CPU时间</code>, 因此 <code>平均请求响应时间</code>不变, 异步模式劣化为串行模式</li>
<li>同时, 由于框架中的各种 await 等待形成了时间片效果, 导致 Node 会在各个请求间对时间片进行调度, 所有请求接近同时完成, <code>请求平均响应时间</code>大幅上升</li>
<li>需要说明的是, 由于事件驱动的随机性, 这里的调度并不是指公平调度, 先进入的请求大概率先集齐所有时间片完成请求, 但不代表先进入的请求一定先完成</li>
</ul>
</li>
<li>对于 io 密集型请求
<ul>
<li>异步框架充分利用 io 等待时间进行 CPU 运算, <code>平均请求响应时间</code>不断缩短, 直到逼近<code>单个请求必要CPU时间</code></li>
<li>随着并发量增大, 在 io 等待时间内(10ms)不足以完成请求, CPU 时间逐渐变为性能瓶颈, 性能表现逐步向计算密集型请求靠近, 体现为<code>请求平均响应时间</code>不断增大</li>
<li>换言之, 由于接收请求/给出响应总会消耗 CPU 资源, <strong>只要并发请求量够大, io 密集型总会退化为 CPU 密集型.</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>顺带提一句, 处理计算密集型请求时还有一个特殊情况:</p>
<p>如果 CPU 运算为整块代码, 期间没有 await 形成时间片供 Node 调度, 那么会 Node 处理模型劣化为串行模式, 执行过程变为<code>接收请求1</code>-&gt;<code>处理响应请求1</code>-&gt;<code>接收请求2</code>-&gt;<code>处理响应请求2</code>-&gt;<code>接收请求3</code>-&gt;<code>处理响应请求3</code>…</p>
<p>由于所有请求同时发出, 串行处理, 所以请求响应时长会呈递增关系, 如下所示</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 示例代码</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;koa&quot;</span>);<br><span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">asyncCPUSleep</span>(<span class="hljs-params">ms = <span class="hljs-number">0</span></span>) &#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1500000</span> * ms; i++) &#123;&#125;<br>  <span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-comment">// response</span><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">async</span> (ctx) =&gt; &#123;<br>  <span class="hljs-comment">// 由于没有promise返回, 这里的await是无效的, 不会形成时间片</span><br>  <span class="hljs-comment">// 阻塞式休眠1秒</span><br>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">asyncCPUSleep</span>(<span class="hljs-number">1000</span>);<br>  ctx.<span class="hljs-property">body</span> = <span class="hljs-string">&quot;Hello Koa&quot;</span>;<br>&#125;);<br><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);<br></code></pre></td></tr></table></figure>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 串行模式对应日志</span><br>第<span class="hljs-number">0</span>条请求完成, 耗时<span class="hljs-number">842</span>毫秒<br>第<span class="hljs-number">1</span>条请求完成, 耗时<span class="hljs-number">1573</span>毫秒<br>第<span class="hljs-number">2</span>条请求完成, 耗时<span class="hljs-number">2275</span>毫秒<br>第<span class="hljs-number">3</span>条请求完成, 耗时<span class="hljs-number">2987</span>毫秒<br>第<span class="hljs-number">4</span>条请求完成, 耗时<span class="hljs-number">3683</span>毫秒<br>第<span class="hljs-number">5</span>条请求完成, 耗时<span class="hljs-number">4396</span>毫秒<br>第<span class="hljs-number">7</span>条请求完成, 耗时<span class="hljs-number">5085</span>毫秒<br>第<span class="hljs-number">6</span>条请求完成, 耗时<span class="hljs-number">5821</span>毫秒<br>第<span class="hljs-number">9</span>条请求完成, 耗时<span class="hljs-number">6535</span>毫秒<br>第<span class="hljs-number">11</span>条请求完成, 耗时<span class="hljs-number">7247</span>毫秒<br>第<span class="hljs-number">8</span>条请求完成, 耗时<span class="hljs-number">7963</span>毫秒<br>第<span class="hljs-number">10</span>条请求完成, 耗时<span class="hljs-number">8671</span>毫秒<br>第<span class="hljs-number">12</span>条请求完成, 耗时<span class="hljs-number">9381</span>毫秒<br>第<span class="hljs-number">13</span>条请求完成, 耗时<span class="hljs-number">10151</span>毫秒<br>第<span class="hljs-number">14</span>条请求完成, 耗时<span class="hljs-number">10852</span>毫秒<br>第<span class="hljs-number">15</span>条请求完成, 耗时<span class="hljs-number">11555</span>毫秒<br>第<span class="hljs-number">16</span>条请求完成, 耗时<span class="hljs-number">12225</span>毫秒<br>第<span class="hljs-number">24</span>条请求完成, 耗时<span class="hljs-number">12996</span>毫秒<br>第<span class="hljs-number">23</span>条请求完成, 耗时<span class="hljs-number">13723</span>毫秒<br>第<span class="hljs-number">25</span>条请求完成, 耗时<span class="hljs-number">14531</span>毫秒<br>第<span class="hljs-number">28</span>条请求完成, 耗时<span class="hljs-number">15235</span>毫秒<br>第<span class="hljs-number">22</span>条请求完成, 耗时<span class="hljs-number">15954</span>毫秒<br>第<span class="hljs-number">18</span>条请求完成, 耗时<span class="hljs-number">16860</span>毫秒<br>第<span class="hljs-number">29</span>条请求完成, 耗时<span class="hljs-number">17906</span>毫秒<br>第<span class="hljs-number">21</span>条请求完成, 耗时<span class="hljs-number">18595</span>毫秒<br>第<span class="hljs-number">26</span>条请求完成, 耗时<span class="hljs-number">19400</span>毫秒<br>第<span class="hljs-number">27</span>条请求完成, 耗时<span class="hljs-number">20333</span>毫秒<br>第<span class="hljs-number">17</span>条请求完成, 耗时<span class="hljs-number">21199</span>毫秒<br>第<span class="hljs-number">20</span>条请求完成, 耗时<span class="hljs-number">22080</span>毫秒<br>第<span class="hljs-number">19</span>条请求完成, 耗时<span class="hljs-number">23064</span>毫秒<br></code></pre></td></tr></table></figure>
<p>但如果在处理过程中不断有 await 形成时间片, 可供 Node 调度. 则 Node 服务仍然遵循异步模型规律, 所有请求一起返回(一起超时)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;koa&quot;</span>);<br><span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">asyncCPUSleep</span>(<span class="hljs-params">ms = <span class="hljs-number">0</span></span>) &#123;<br>  <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">reslove, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1500000</span> * ms; i++) &#123;&#125;<br>      <span class="hljs-title function_">reslove</span>(<span class="hljs-literal">true</span>);<br>    &#125;, <span class="hljs-number">0</span>);<br>  &#125;);<br>  <span class="hljs-keyword">return</span>;<br>&#125;<br><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">async</span> (ctx) =&gt; &#123;<br>  <span class="hljs-comment">// 切片式休眠1秒</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) &#123;<br>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">asyncCPUSleep</span>(<span class="hljs-number">10</span>);<br>  &#125;<br>  ctx.<span class="hljs-property">body</span> = <span class="hljs-string">&quot;Hello Koa&quot;</span>;<br>&#125;);<br><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);<br></code></pre></td></tr></table></figure>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 异步模式对应日志</span><br>第<span class="hljs-number">0</span>条请求完成, 耗时<span class="hljs-number">27696</span>毫秒<br>第<span class="hljs-number">1</span>条请求完成, 耗时<span class="hljs-number">27701</span>毫秒<br>第<span class="hljs-number">2</span>条请求完成, 耗时<span class="hljs-number">27711</span>毫秒<br>第<span class="hljs-number">3</span>条请求完成, 耗时<span class="hljs-number">27721</span>毫秒<br>第<span class="hljs-number">4</span>条请求完成, 耗时<span class="hljs-number">27731</span>毫秒<br>第<span class="hljs-number">5</span>条请求完成, 耗时<span class="hljs-number">27741</span>毫秒<br>第<span class="hljs-number">6</span>条请求完成, 耗时<span class="hljs-number">27751</span>毫秒<br>第<span class="hljs-number">7</span>条请求完成, 耗时<span class="hljs-number">27760</span>毫秒<br>第<span class="hljs-number">8</span>条请求完成, 耗时<span class="hljs-number">27770</span>毫秒<br>第<span class="hljs-number">9</span>条请求完成, 耗时<span class="hljs-number">27780</span>毫秒<br>第<span class="hljs-number">10</span>条请求完成, 耗时<span class="hljs-number">27790</span>毫秒<br>第<span class="hljs-number">11</span>条请求完成, 耗时<span class="hljs-number">27799</span>毫秒<br>第<span class="hljs-number">12</span>条请求完成, 耗时<span class="hljs-number">27808</span>毫秒<br>第<span class="hljs-number">13</span>条请求完成, 耗时<span class="hljs-number">27818</span>毫秒<br>第<span class="hljs-number">14</span>条请求完成, 耗时<span class="hljs-number">27827</span>毫秒<br>第<span class="hljs-number">15</span>条请求完成, 耗时<span class="hljs-number">27837</span>毫秒<br>第<span class="hljs-number">16</span>条请求完成, 耗时<span class="hljs-number">27847</span>毫秒<br>第<span class="hljs-number">17</span>条请求完成, 耗时<span class="hljs-number">27857</span>毫秒<br>第<span class="hljs-number">18</span>条请求完成, 耗时<span class="hljs-number">27866</span>毫秒<br>第<span class="hljs-number">19</span>条请求完成, 耗时<span class="hljs-number">27875</span>毫秒<br>第<span class="hljs-number">20</span>条请求完成, 耗时<span class="hljs-number">27885</span>毫秒<br>第<span class="hljs-number">21</span>条请求完成, 耗时<span class="hljs-number">27895</span>毫秒<br>第<span class="hljs-number">22</span>条请求完成, 耗时<span class="hljs-number">27905</span>毫秒<br>第<span class="hljs-number">23</span>条请求完成, 耗时<span class="hljs-number">27917</span>毫秒<br>第<span class="hljs-number">24</span>条请求完成, 耗时<span class="hljs-number">27927</span>毫秒<br>第<span class="hljs-number">25</span>条请求完成, 耗时<span class="hljs-number">27937</span>毫秒<br>第<span class="hljs-number">26</span>条请求完成, 耗时<span class="hljs-number">27946</span>毫秒<br>第<span class="hljs-number">27</span>条请求完成, 耗时<span class="hljs-number">27957</span>毫秒<br>第<span class="hljs-number">28</span>条请求完成, 耗时<span class="hljs-number">27963</span>毫秒<br>第<span class="hljs-number">29</span>条请求完成, 耗时<span class="hljs-number">27973</span>毫秒<br></code></pre></td></tr></table></figure>
<p>一般而言, 由于 web 接口中总有需要 await 的地方(动态文件路由/远程接口调用/MySQL 查询/中间件处理/接口返回/etc), 所以不会出现纯计算密集型的现象, 基本上是…一起超时, 一起报警.</p>
<h1>后续</h1>
<p>了解异步模型的这个特征后, 服务器突发的 504 报警的原因就很清楚了. 由于线上服务器流量过大, CPU 性能成为接口瓶颈(稳定在 20%~30%, 相当于在临界点徘徊), 导致当 QPS 提升时接口超时, Nginx 自动返回 504. 实际上, 在这次故障期间, 每一个请求 Node 最后都有响应, 只是响应时间非常长, 有一个请求的响应时长甚至达到了 118.36 秒. 这也是为什么只有 Nginix 日志有 504 记录, 服务器日志全部都是 200 的原因.</p>
<p>发现问题后第一时间向运维申请增加了服务器, 后来也给常用计算逻辑添加了 redis 缓存, 将 CPU 负载由 15%~25% 降低到了 4%~5%, 从而解决了这个问题.</p>
<p>事实上, 由于存在<code>单个请求必要CPU时间</code>, 在<strong>保证每个请求响应时间可接受</strong>的前提下, 实际业务 Node 很难打到很高的 QPS 值, 一般的 SSR 服务也只有 50 左右. 对于高并发情况, 常见的解决方案一般是以下几种</p>
<ul>
<li>启动集群模式(cluster). 在默认状态下, 单进程只能使用 CPU 的一个核, 这样导致服务器上其他的 31/63 个核事实上被浪费了. 启动集群模式后, Node 服务的 QPS 值大致扩张为单进程状态下 QPS * 系统核心数, 基本可以满足线上服务需要
<ul>
<li>PS: 这实际上是 php-fpm 的做法, 所有请求来到 Nginx 后进行负载均衡, 将请求分散到后端的 32 个进程上, 虽然每个进程的 QPS 只有 30, 但由于进程总数大, 最后的 QPS 仍然有 900~1000</li>
</ul>
</li>
<li>缓存运算结果, 将计算结果存在 redis/memcache</li>
<li>优化代码逻辑, 避免冗余运算</li>
<li>加机器.</li>
</ul>
<p>但一般来说, 如果发现 CPU 使用率飙升, 接口响应时间随着并发量快速增长且隐隐有突破 1 秒的趋势时, 不用考虑太多, 加机器吧.</p>
<blockquote>
<p>程序员的时间比计算机的时间更宝贵</p>
<p>---- 编程人生, 第五章, Joshua Bloch</p>
</blockquote>
<h1>附注</h1>
<ol>
<li>高 QPS 的响应时间问题只对高计算量的 Node 服务有意义. 这次服务故障是因为使用了 ORM 对数据进行反复建模浪费了大量计算性能, SSR 的 QPS 低是因为要在服务器上完成本应由浏览器完成的 js 处理逻辑. 但如果只进行后台服务转发, io 时长(远端接口响应时长)远大于自身计算时长, 这是最适合 Node 使用的业务场景, 一般不需要担心 QPS 问题.</li>
<li>文中进行的计算密集型/io 密集型压力测试结果如下
<ul>
<li>计算密集型
<ul>
<li>计算密集型-并发 1
<ul>
<li><img src="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C/%E8%AE%A1%E7%AE%97%E5%AF%86%E9%9B%86%E5%9E%8B-%E5%B9%B6%E5%8F%911.png" alt="计算密集型-并发1.png"></li>
</ul>
</li>
<li>计算密集型-并发 10
<ul>
<li><img src="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C/%E8%AE%A1%E7%AE%97%E5%AF%86%E9%9B%86%E5%9E%8B-%E5%B9%B6%E5%8F%9110.png" alt="计算密集型-并发10.png"></li>
</ul>
</li>
<li>计算密集型-并发 100
<ul>
<li><img src="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C/%E8%AE%A1%E7%AE%97%E5%AF%86%E9%9B%86%E5%9E%8B-%E5%B9%B6%E5%8F%91100.png" alt="计算密集型-并发100.png"></li>
</ul>
</li>
<li>计算密集型-并发 400
<ul>
<li><img src="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C/%E8%AE%A1%E7%AE%97%E5%AF%86%E9%9B%86%E5%9E%8B-%E5%B9%B6%E5%8F%91400.png" alt="计算密集型-并发400.png"></li>
</ul>
</li>
</ul>
</li>
<li>io 密集型
<ul>
<li>io 密集型-并发 1
<ul>
<li><img src="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C/io%E5%AF%86%E9%9B%86%E5%9E%8B-%E5%B9%B6%E5%8F%911.png" alt="io密集型-并发1.png"></li>
</ul>
</li>
<li>io 密集型-并发 10
<ul>
<li><img src="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C/io%E5%AF%86%E9%9B%86%E5%9E%8B-%E5%B9%B6%E5%8F%9110.png" alt="io密集型-并发10.png"></li>
</ul>
</li>
<li>io 密集型-并发 100
<ul>
<li><img src="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C/io%E5%AF%86%E9%9B%86%E5%9E%8B-%E5%B9%B6%E5%8F%91100.png" alt="io密集型-并发100.png"></li>
</ul>
</li>
<li>io 密集型-并发 400
<ul>
<li><img src="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C/io%E5%AF%86%E9%9B%86%E5%9E%8B-%E5%B9%B6%E5%8F%91400.png" alt="io密集型-并发400.png"></li>
</ul>
</li>
<li>io 密集型-并发 1000
<ul>
<li><img src="https://cdn.jsdelivr.net/gh/YaoZeyuan/blog/source/_posts/2021/06/./img/%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C/io%E5%AF%86%E9%9B%86%E5%9E%8B-%E5%B9%B6%E5%8F%911000.png" alt="io密集型-并发1000.png"></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<h1>参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000039165643">深入理解 nodejs 的 HTTP 处理流程</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>异步模型的脆折风险----从一次 Node 服务故障谈起</div>
      <div>https://www.yaozeyuan.online/2021/06/28/2021/06/异步模型的脆折风险----从一次 Node 服务故障谈起/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>姚泽源</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2021年6月28日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/07/28/2021/07/%E5%BE%AE%E5%A3%B3%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84%E6%A6%82%E8%A7%88/" title="微壳小程序技术架构概览">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">微壳小程序技术架构概览</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/02/04/2021/02/%E4%B8%BA%E4%BB%80%E4%B9%88%E5%AD%A6%E7%94%9F%E4%B8%8D%E5%96%9C%E6%AC%A2%E4%B8%8A%E5%AD%A6/" title="读书分享:为什么学生不喜欢上学">
                        <span class="hidden-mobile">读书分享:为什么学生不喜欢上学</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments">
    
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://lib.baomitu.com/gitalk/1.7.2/gitalk.min.js', function() {
        var options = Object.assign(
          {"clientID":"cb51e467ab7545f311d9","clientSecret":"8712d8263ec17f168dc461ec5ba948d71ea9fb06","repo":"YaoZeyuan.github.io","owner":"YaoZeyuan","admin":["YaoZeyuan"],"language":"zh-CN","labels":["Gitalk"],"perPage":10,"pagerDirection":"last","distractionFreeMode":false,"createIssueManually":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","id":"pageId"},
          {
            id: 'b3b78e74f12d75fdf91870784c8757a1'
          }
        )
        var gitalk = new Gitalk(options);
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>







  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>




  
<script src="/static/js/customer.js"></script>
<script src="/static/js/md5.min.js"></script>
<script src="/static/js/gitalk.config.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
